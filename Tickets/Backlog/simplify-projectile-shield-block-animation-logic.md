Ticket ID: VFX-R7 (Refactor)
Title: VFX: Simplify Projectile Shield Block Animation Logic
Goal: Refactor the projectile blocking visual logic within VFX:updateProjectile for increased clarity, reliability, and maintainability, while ensuring a clear "stop and shatter" visual.
Problem: The current logic in VFX:updateProjectile for handling blocked effects (if isBlocked...) is complex, involving multiple flags (blockTimerStarted, impactParticlesCreated, blockLogged), potentially racy timers, and spawning secondary effects (shield_hit_base). This complexity can lead to inconsistent visuals (partial animations, effect ending prematurely) and is hard to debug.
Tasks:
Modify VFX:updateProjectile (vfx.lua):
Locate the if isBlocked then ... end block.
Simplify State: Rely primarily on detecting effect.visualProgress >= effect.options.blockPoint. Remove blockTimerStarted and potentially impactParticlesCreated if the impact visual can be integrated.
Integrate Impact Visual: Instead of creating a separate shield_hit_base effect, consider adding a short-lived "impact particle group" directly to the current effect instance when the block occurs. These particles would handle the "shatter" flash at the blockX, blockY point. Alternatively, ensure the EFFECT event generated by EventRunner for the BLOCKED_DAMAGE only triggers the shield_hit_base effect, and updateProjectile focuses solely on stopping/scattering its own particles.
Simplify Particle Scattering: When the block is detected:
Immediately stop the forward motion of core particles (set speedX/Y = 0 or apply strong opposing force).
Initiate a consistent scattering/fading animation for all particles (core and trail) originating from the blockX, blockY point. This could reuse or adapt the existing deflect* logic but trigger it more deterministically.
Standardize Cleanup: When the block occurs, set a fixed additional duration for the effect (e.g., effect.duration = effect.timer + 0.5) to allow the scatter/fade animation to complete reliably before the effect is removed by the main VFX.update loop. Remove any logic that artificially speeds up effect.timer after a block.
Acceptance Criteria:
The visual sequence for a blocked projectile (stop -> impact flash -> particle scatter -> fade) is clear and consistent across different ranges and block timings.
The code within VFX:updateProjectile's blocking section is simpler and easier to follow.
The reliance on multiple boolean flags for state tracking within the block sequence is reduced.
Blocked effects reliably clean themselves up after the scatter/fade animation completes.
No VFX objects or particles are leaked (verify with pool stats).
Notes:
This focuses on reliability and maintainability of the blocking visual.
It might involve choosing between integrating the impact flash into the main effect vs. ensuring the separately spawned shield_hit_base effect works reliably. Integrating might be cleaner if feasible.
Depends on VFX-P1 (Dynamic Block Point) for the most accurate visual positioning, but can be done independently focusing purely on the animation logic after a block is detected.
Priority: Medium (Post-Demo, improves stability)