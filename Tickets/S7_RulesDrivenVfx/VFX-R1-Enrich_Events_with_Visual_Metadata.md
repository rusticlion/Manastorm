# Ticket #VFX-R1: Enrich Events with Visual Metadata

## Goal
Ensure gameplay events generated by keywords contain rich metadata (affinity, attackType, manaCost, tags, rangeBand, elevation) so the forthcoming `VisualResolver` can make accurate decisions.

## Tasks
1. **Modify `SpellCompiler.compileSpell` (`spellCompiler.lua`):**
   * When iterating through spell keywords, store the base `spell.affinity` and `spell.attackType` within the `compiledSpell` object so they are accessible during event generation.

2. **Update Keyword `execute` Functions (`keywords.lua`):**
   * For keywords that generate core gameplay events (e.g., `damage`, `apply_status`, `conjure`, `block`, `elevate`, `ground`, etc.), update their `execute` function signature to accept `spell` (the compiled spell object) as an argument, likely passed down from `executeAll`.
   * When creating an event within a keyword's `execute` function, add the relevant fields derived from the spell and current state:
     * `affinity  = spell.affinity`
     * `attackType = spell.attackType`
     * `tags      = { DAMAGE = true }` (or `BURN = true`, `SHIELD = true`, etc., based on the keyword's purpose)
     * `manaCost  = #slot.tokens` (approximate cost; requires access to `slot`)
     * `rangeBand = caster.gameState.rangeState`
     * `elevation = caster.elevation`

3. **Modify `SpellCompiler.executeAll` (`spellCompiler.lua`):**
   * Update calls to keyword `execute` functions to pass the necessary context (including the compiled spell object and potentially the slot table or index) so they can access `affinity`, `attackType`, `slot.tokens`, etc.

## Acceptance Criteria
* Key gameplay events (`DAMAGE`, `APPLY_STATUS`, `CONJURE_TOKEN`, `CREATE_SHIELD`, `SET_ELEVATION`, etc.) generated by keywords now include `affinity`, `attackType`, `manaCost`, `tags`, `rangeBand`, and `elevation` fields.
* Event generation functions correctly and does not introduce runtime errors.

## Design Notes / Pitfalls
* Accurately calculating `manaCost` may be tricky if tokens aren't fully assigned when the event is created; using `#slot.tokens` is a pragmatic first step.
* Passing the `compiledSpell` object down through `executeAll` to keyword `execute` functions is necessary for access to spell-level metadata.
* Ensure tag names are consistent and documented (e.g., use the keyword's `behavior.category` or a curated tag list). 