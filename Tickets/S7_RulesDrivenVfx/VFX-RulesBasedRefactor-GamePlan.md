Manastorm VFX Refactoring: Game Plan
Version: 1.0
Date: 2025-04-28
Context: This document provides a high-level overview for the VFX system refactoring outlined in tickets VFX-R1 through VFX-R6.
1. Purpose & Problem Statement
Goal: To refactor Manastorm's Visual Effects (VFX) system, making it more consistent, maintainable, and driven by the game's core rules rather than manual specification for every spell.
Current Problem: Our current system triggers VFX in several different places and often requires developers to manually specify both the gameplay effect (e.g., deal fire damage) and the visual effect (e.g., play the "firebolt" animation). This leads to:
Duplication: We often say the same thing twice (rule + visual).
Inconsistency: It's easy for visuals to drift out of sync with gameplay rules or element types.
Maintenance Overhead: Changing a spell's element might require hunting down and changing its VFX specification separately.
Scattered Logic: VFX triggers are spread across wizard.lua, manapool.lua, and the EventRunner, making it hard to track how visuals are initiated.
2. Target Architecture: Rule-Driven Visuals
We are moving to a rule-driven VFX system. The core idea is:
Gameplay Events should imply the necessary visuals.
Instead of manually telling the VFX system exactly which effect to play for most spells, we will:
Enrich Gameplay Events: Ensure events generated by keywords (like DAMAGE, APPLY_STATUS, CONJURE_TOKEN) contain key metadata about the action:
affinity (Fire, Moon, Salt, etc.)
attackType (Projectile, Remote, Zone, Utility)
manaCost (as a proxy for power/intensity)
tags (indicating specific mechanics like Burn, Shield, Conjure)
Positional context (rangeBand, elevation)
Introduce a VisualResolver: This new module will look at the metadata within an incoming event.
Derive Visuals: Based on the event's metadata, the VisualResolver will intelligently select:
A base VFX template (e.g., a generic projectile, beam, impact, or aura).
A color tint based on the affinity.
A scale/intensity modifier based on the manaCost.
A particle motion style based on the affinity (e.g., radial bursts for Fire, swirls for Water).
Potentially small additive overlay effects based on tags (e.g., embers for Burn, sparkles for Conjure).
Centralized Triggering: The EventRunner will be the primary system responsible for calling the VisualResolver and then triggering the VFX module with the derived template name and parameters. Manual specification of VFX (vfx = { effectOverride = ... }) becomes the exception for unique, cinematic moments, not the rule.
3. Key Benefits of This Approach
Single Source of Truth: Gameplay rules (keywords, spell definitions) define the effect; visuals follow automatically.
Consistency: All Fire projectiles will share visual characteristics, tinted correctly. All Water effects will have a distinct motion style.
Reduced Boilerplate: No need to add vfx = ... to most spell definitions.
Easier Design Iteration: Change a spell's affinity, and its visual color/motion updates automatically. Add a new element, and you primarily need to add its color/motion to the VisualResolver.
Improved Readability: Players can learn to visually associate colors, motions, and shapes with specific elements and attack types.
Maintainability: VFX logic is centralized in the VisualResolver and VFX module.
4. How the Tickets Fit Together (VFX-R1 to VFX-R6)
This refactor is broken down into manageable steps:
VFX-R1 (Enrich Events): Focuses on making sure the data needed by the resolver (affinity, attackType, cost, tags etc.) gets added to the events when keywords execute.
VFX-R2 (Implement Resolver): Creates the core VisualResolver module with the logic to map event data to visual parameters (template, color, scale, motion).
VFX-R3 (Integrate Resolver): Modifies the EventRunner to use the VisualResolver when it processes EFFECT events (and potentially other relevant events like SET_ELEVATION).
VFX-R4 (Adapt VFX Module): Updates the VFX module itself to understand the generic base templates, apply tints/scales/motion styles, and handle additive effects passed from the resolver.
VFX-R5 (Deprecate Manual VFX): Cleans up spells.lua by removing most of the now-redundant manual vfx specifications, relying on the resolver instead. It also refactors the vfx keyword to only handle explicit overrides.
VFX-R6 (Shield Impacts): Ensures shield blocking correctly triggers a distinct visual effect via the new event/resolver pipeline.
5. Example Flow (Post-Refactor)
Wizard casts "Tidal Force" (Water Affinity, Remote Attack, 2 Mana).
The damage keyword executes, generating a DAMAGE event.
The event includes: { type="DAMAGE", affinity="water", attackType="remote", manaCost=2, tags={DAMAGE=true}, rangeBand="NEAR", ... }.
EventRunner processes this event.
EventRunner calls VisualResolver.pick(event).
VisualResolver sees attackType="remote" -> chooses "beam_base". Sees affinity="water" -> chooses OCEAN color and SWIRL motion. Sees manaCost=2 -> calculates scale=1.1. Sees tags={DAMAGE=true} -> maybe adds no specific addon.
VisualResolver returns ("beam_base", {color=OCEAN, scale=1.1, motion=SWIRL, addons={}, ...}).
EventRunner calls VFX.createEffect("beam_base", srcX, srcY, tgtX, tgtY, {color=OCEAN, scale=1.1, motion=SWIRL, ...}).
The VFX module renders a generic beam, tinted blue, slightly larger than default, with particles that swirl.
6. Guidance for Implementation
Focus on Events: Think about what information an event needs to carry for the VisualResolver to work.
Use Constants: Rely heavily on core/Constants.lua for affinities, attack types, colors, and the new motion styles.
Understand the Resolver: The VisualResolver is the central mapping layer. Keep its logic clear and based on the event data.
Test Incrementally: After each ticket, test relevant spells to ensure visuals are still triggering and gradually adopting the new rule-driven appearance.
Keep it Simple Initially: The base templates and motion styles can start very basic. The goal is functional consistency first, polish later.
7. Conclusion
This refactor moves Manastorm towards a more elegant and maintainable VFX system where visuals are a direct reflection of the underlying gameplay rules. While it involves touching several core systems, the end result will be a cleaner codebase and a more consistent visual experience for players.